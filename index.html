<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workflow Agent - 启动卡片收缩到工作台（输入居中在左栏，含评分）</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#111827;
      --accent:#3b82f6; /* 改为蓝色主题 */
      --accent-weak:#dbeafe; /* 蓝色弱化版本 */
      --progress:#3b82f6; /* 进度条也改为蓝色 */
      --line:#d1d5db;
      --node-bg:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:linear-gradient(180deg,#fff, var(--bg));
      overflow:hidden;
    }

    .stage{position:relative;height:100vh;width:100%}

    /* Phase 1：全屏启动界面 */
    .launch{
      position:fixed;inset:0;z-index:30;
      display:flex;background:var(--bg);
      transition:opacity .3s ease,transform .3s ease;
    }
    .launch-left{flex:0 0 15%;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
    .launch-right{flex:1;background:var(--card);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:80px 120px;width:100%}
    .logo{display:flex;align-items:center;gap:16px;margin-bottom:1.5rem}
    .logo-badge{width:44px;height:44px;border-radius:11px;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:grid;place-items:center;color:#1e40af;font-weight:900;font-size:17px;box-shadow:0 6px 20px rgba(59,130,246,.35)}
    .logo-title{margin:0;font-size:26px;font-weight:800;letter-spacing:-0.3px}
    .launch .hint{font-size:15px;color:var(--muted);margin-top:0.5rem;text-align:center;max-width:700px;line-height:1.6;padding:0 20px}
    .form{display:flex;gap:16px;align-items:center;width:100%;max-width:750px;margin-bottom:0}
    .input{flex:1;padding:18px 22px;border:1px solid var(--border);border-radius:15px;font-size:15px;outline:none;transition:box-shadow .2s,border-color .2s;min-height:52px}
    .input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px var(--accent-weak)}
    .btn{padding:18px 28px;background:var(--primary);color:#fff;border:none;border-radius:15px;font-size:15px;cursor:pointer;transition:transform .06s,opacity .2s,background .2s;font-weight:600;min-height:52px;white-space:nowrap}
    .btn:hover{background:#000}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* 启动页：标签与广场样式 */
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;color:#1f2937;background:#f3f4f6;border:1px solid var(--border);transition:filter .15s,transform .06s}
    .tab:hover{filter:brightness(0.98)}
    .tab:active{transform:translateY(1px)}
    .tab--active{background:var(--accent-weak);border-color:#bfdbfe;color:#1e40af;font-weight:700}
    .tab-panels{display:block}
    .tab-panel{display:none}
    .tab-panel.active{display:block}
    .left-header{padding:20px 16px 16px 16px;border-bottom:1px solid var(--border)}
    .left-title{margin:0 0 12px 0;font-weight:800;font-size:16px;color:#0f172a}
    .left-content{flex:1;padding:16px;overflow:auto}
    
    /* 导航按钮样式 */
    .nav-buttons{display:flex;flex-direction:column;gap:12px}
    .nav-btn{display:flex;align-items:center;gap:12px;width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#374151;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease;text-align:left}
    .nav-btn:hover{background:#f8fafc;border-color:#c7d2fe;color:#1e40af;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .nav-btn:active{transform:translateY(0);box-shadow:0 1px 4px rgba(0,0,0,.12)}
    .nav-icon{font-size:18px;flex-shrink:0}
    .nav-text{flex:1}

    /* 广场页面样式 */
    .square-page{position:fixed;inset:0;z-index:30;display:flex;flex-direction:column;background:var(--bg);opacity:0;transform:translateX(20px);transition:opacity .3s ease,transform .3s ease;pointer-events:none}
    .square-page.visible{opacity:1;transform:translateX(0);pointer-events:auto}
    .square-header{display:flex;align-items:center;gap:16px;padding:20px 24px;border-bottom:1px solid var(--border);background:var(--card)}
    .back-btn{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#374151;font-size:14px;cursor:pointer;transition:all .2s ease}
    .back-btn:hover{background:#f8fafc;border-color:#c7d2fe;color:#1e40af}
    .square-title{margin:0;font-size:20px;font-weight:700;color:#111827}
    .square-content{flex:1;padding:24px;overflow:auto}
    .square-toolbar{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
    .square-toolbar .input{max-width:400px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:#374151;cursor:pointer}
    .chip.active{background:#dbeafe;color:#1e40af;border-color:#bfdbfe}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px;display:flex;flex-direction:column;gap:8px}
    .card h4{margin:0;font-size:14px}
    .card p{margin:0;color:#6b7280;font-size:12px}
    .card .meta{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#64748b}
    .select-btn{padding:8px 10px;border:none;border-radius:10px;background:var(--accent);color:#1e3a8a;cursor:pointer;font-size:12px}
    .select-btn.selected{background:#10b981;color:#064e3b}
    .selected-bar{display:flex;gap:12px;flex-wrap:wrap;margin-top:1rem;justify-content:center;min-height:40px;max-width:750px;width:100%}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:7px 16px;border-radius:999px;background:#e0f2fe;color:#0c4a6e;border:1px solid #bae6fd;font-size:13px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .badge .x{cursor:pointer;color:#0369a1;margin-left:4px;font-weight:600;opacity:0.7;transition:opacity .2s}
    .badge .x:hover{opacity:1}
    @media (max-width:1400px){
      .launch-right{padding:70px 100px}
    }
    @media (max-width:1200px){
      .launch-right{padding:60px 80px}
    }
    @media (max-width:960px){
      .launch{flex-direction:column}
      .launch-left{flex:unset;border-right:none;border-bottom:1px solid var(--border)}
      .launch-right{padding:50px 30px;width:100%}
      .logo{margin-bottom:1.2rem;gap:14px}
      .logo-badge{width:40px;height:40px;font-size:15px}
      .logo-title{font-size:22px}
      .form{max-width:100%;gap:14px;margin-bottom:0}
      .input{padding:16px 20px;font-size:15px;min-height:50px}
      .btn{padding:16px 24px;font-size:15px;min-height:50px}
      .launch .hint{font-size:14px;max-width:100%;margin-top:0.5rem;padding:0 10px}
      .selected-bar{margin-top:1rem;gap:10px;max-width:100%}
      .badge{padding:6px 14px;font-size:12px}
      .grid{grid-template-columns:1fr}
    }
    @media (max-width:480px){
      .launch-right{padding:40px 20px}
      .logo{margin-bottom:1rem;gap:12px}
      .logo-badge{width:36px;height:36px;font-size:14px}
      .logo-title{font-size:20px}
      .form{flex-direction:column;gap:12px;align-items:stretch;margin-bottom:0}
      .input{min-height:48px;padding:14px 18px;font-size:15px}
      .btn{min-height:48px;padding:14px 20px;font-size:15px}
      .launch .hint{font-size:13px;margin-top:0.5rem;padding:0 5px}
      .selected-bar{margin-top:1rem;gap:8px}
      .badge{padding:5px 12px;font-size:11px}
    }

    /* Phase 2：工作台 */
    .workbench{position:absolute;inset:0;padding:16px;opacity:0;transform:translateY(12px);transition:opacity .35s ease,transform .35s ease;pointer-events:none}
    .workbench.visible{opacity:1;transform:translateY(0);pointer-events:auto}
    .columns{height:100%;display:grid;grid-template-columns:1.6fr 1fr;gap:16px;transition:grid-template-columns 0.4s ease}
    .columns.single{grid-template-columns:1fr}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.04)}
    .panel__head{padding:12px 16px 10px 16px;border-bottom:1px solid var(--border)}
    .title{margin:0;font-size:16px;font-weight:700}
    .subtitle{margin:4px 0 0 0;font-size:12px;color:var(--muted)}

    /* 聊天容器：将消息轨道居中显示，两侧留白 */
    .chat__container{
      flex:1;overflow:auto;padding:14px;scroll-behavior:smooth;
      background:radial-gradient(1000px 200px at 10% 0%, rgba(59,130,246,.05), transparent 60%),radial-gradient(800px 200px at 90% 0%, rgba(59,130,246,.05), transparent 60%);
      display:flex;flex-direction:column;align-items:center; /* 关键：在面板内部居中 */
    }
    .panel__footer{border-top:1px solid var(--border);padding:12px;background:#fff}
    .panel__footer .form{max-width:720px;margin:0 auto;gap:8px}
    .panel__footer .input{flex:1}

    /* 消息轨道最大宽度，居中，两侧留空 */
    .msg{display:flex;width:100%;max-width:840px;margin:8px 0;opacity:0;transform:translateY(8px);animation:fadeIn .25s ease forwards}
    .msg--user{justify-content:flex-end}
    .bubble{max-width:76%;padding:10px 12px;border-radius:14px;font-size:14px;line-height:1.5;box-shadow:0 2px 8px rgba(0,0,0,.04);white-space:pre-wrap}
    .bubble--user{background:#2563eb;color:#fff;border-top-left-radius:14px;border-bottom-left-radius:14px;border-top-right-radius:14px}
    .bubble--system{background:#f9fafb;color:#111827;border:1px solid var(--border);border-top-right-radius:14px;border-bottom-right-radius:14px;border-top-left-radius:14px}
    .small{margin-top:6px;font-size:12px;color:var(--muted)}

    .planning{border:1px dashed #bfdbfe;border-radius:12px;padding:10px;background:#eff6ff}
    .planning h4{margin:0 0 6px 0;font-size:14px}
    .planning ol{margin:8px 0 8px 18px;padding:0}
    .planning li{margin:6px 0}
    .planning .start-btn{display:inline-block;margin-top:8px;padding:8px 12px;background:var(--accent);color:#1e40af;border:none;border-radius:10px;cursor:pointer;font-size:13px;transition:filter .15s,transform .06s}
    .planning .start-btn:hover{filter:brightness(0.95)}
    .planning .start-btn:active{transform:translateY(1px)}

    /* 新的卡片样式 */
    .analysis-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .analysis-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .analysis-icon{font-size:16px}
    .analysis-title{font-weight:600;font-size:14px;color:#111827}
    .analysis-status{font-size:12px;color:#6b7280;margin-left:auto}
    .analysis-content{display:flex;flex-direction:column;gap:4px}
    .analysis-item{font-size:12px;color:#374151;padding:2px 0;line-height:1.4}

    .steps-container{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .steps-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .steps-icon{font-size:16px}
    .steps-title{font-weight:600;font-size:14px;color:#111827}
    .steps-list{display:flex;flex-direction:column;gap:6px}
    .step-item{display:flex;align-items:center;gap:8px;padding:4px 0}
    .step-circle{font-size:14px;color:#6b7280;min-width:16px;text-align:center}
    .step-title{font-size:13px;color:#374151}
    .step-running .step-title{color:#3b82f6;font-weight:500}
    .step-completed .step-title{color:#059669;font-weight:500}

    .tool-card{border:1px solid #d1d5db;border-radius:10px;padding:10px;background:#f9fafb;margin:8px 0;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .tool-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .tool-name{font-weight:600;font-size:12px;color:#1e40af}
    .tool-action{font-size:11px;color:#6b7280}
    .tool-params{margin-bottom:6px}
    .param-item{display:flex;gap:4px;font-size:11px}
    .param-key{color:#6b7280;font-weight:500}
    .param-value{color:#374151;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tool-status{font-size:11px;color:#6b7280;text-align:right}

    .result-card{border:1px solid #10b981;border-radius:12px;padding:12px;background:#f0fdf4;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .result-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .result-icon{font-size:16px}
    .result-title{font-weight:600;font-size:14px;color:#059669}
    .result-content{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
    .result-item{font-size:13px;color:#374151;line-height:1.4}
    .result-meta{font-size:11px;color:#6b7280;text-align:right}

    /* 简约风格：思考气泡与内联选择 */
    .thought{position:relative;border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 10px}
    .thought-head{display:flex;align-items:center;gap:6px;margin-bottom:4px}
    .thought-icon{font-size:15px}
    .thought-title{font-weight:600;font-size:13px;color:#111827}
    .thought-body{font-size:13px;color:#374151;line-height:1.45}
    .thought-footer{display:flex;justify-content:flex-end;margin-top:4px}
    .thought-toggle{border:none;background:#f3f4f6;color:#374151;padding:5px 9px;border-radius:8px;font-size:12px;cursor:pointer}

    .inline-choice{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px 12px}
    .inline-choice-title{font-weight:600;font-size:13px;margin-bottom:8px;color:#111827}
    .inline-choice-options{display:flex;gap:8px;flex-wrap:wrap}
    .inline-choice-btn{padding:6px 12px;border:1px solid #dbeafe;border-radius:999px;background:#fff;color:#1e40af;font-size:12px;cursor:pointer}
    .inline-choice-btn.selected{background:#1e40af;color:#fff;border-color:#1e40af}

    /* 简约风格：最小化结果卡片 */
    .result-card.minimal{border:1px solid var(--border);background:#fff;box-shadow:none}
    .result-card.minimal .result-title{color:#111827}

    /* 分层文本行（步骤开始/调用/思考） */
    .flow-line{font-size:13px;color:#111827;margin:6px 0}
    .flow-line.root{font-weight:600}
    .flow-line.indent-1{margin-left:16px;color:#374151}

    /* 思考中标签样式（用于需求分析与步骤间思考） */
    .thinking-bubble .tag{position:absolute;top:-9px;left:10px;z-index:1;display:inline-block;font-size:11px;color:#475569;background:#eef2f7;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

    @media (max-width:480px){
      .thinking-bubble .tag{top:-8px;left:8px}
      .thought{padding:8px 10px}
      .thought-body{line-height:1.5}
    }

    .rethink-card{border:1px solid #f59e0b;border-radius:12px;padding:12px;background:#fffbeb;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .rethink-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .rethink-icon{font-size:16px}
    .rethink-title{font-weight:600;font-size:14px;color:#d97706}
    .rethink-content{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
    .rethink-item{font-size:12px;color:#374151;padding:2px 0;line-height:1.4}
    .rethink-status{font-size:11px;color:#d97706;text-align:right}

    .choice-card{border:1px solid #8b5cf6;border-radius:12px;padding:12px;background:#faf5ff;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .choice-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .choice-icon{font-size:16px}
    .choice-title{font-weight:600;font-size:14px;color:#7c3aed}
    .choice-options{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .choice-btn{padding:6px 12px;border:1px solid #c4b5fd;border-radius:8px;background:#fff;color:#7c3aed;font-size:12px;cursor:pointer;transition:all .15s}
    .choice-btn:hover{background:#f3f4f6;border-color:#a78bfa}
    .choice-btn.selected{background:#7c3aed;color:#fff;border-color:#7c3aed}
    .choice-status{font-size:11px;color:#6b7280;text-align:right}

    /* 右侧工作台状态面板 */
    .status-panel{padding:16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff,#fcfdfc)}
    .status-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .status-item:last-child{margin-bottom:0}
    .status-label{font-size:12px;color:var(--muted);font-weight:500}
    .status-value{font-size:13px;color:#111827;font-weight:600}
    .progress-container{display:flex;align-items:center;gap:8px;flex:1}
    .progress-text{font-size:11px;color:var(--muted);min-width:30px;text-align:right}

    /* 取消抽象进度条视觉，改为具体工具调用日志 */

    .workflow{background:var(--card);border:1px solid var(--border);border-radius:16px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.04);opacity:0;transform:translateX(20px);transition:opacity 0.4s ease,transform 0.4s ease}
    .workflow.visible{opacity:1;transform:translateX(0)}
    .workflow__head{padding:12px 16px 10px 16px;border-bottom:1px solid var(--border)}
    .workflow__tabs{display:flex;gap:8px;margin-top:8px}
    .workflow__tab{padding:6px 12px;border:1px solid var(--border);background:#fff;border-radius:8px;font-size:12px;color:#374151;cursor:pointer}
    .workflow__tab--active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3;font-weight:600}
    .workflow__body{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .tab-pane{display:none;height:100%}
    .tab-pane.active{display:block}
    .files__header{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:600;color:#111827}
    .files__list{list-style:none;margin:0;padding:10px 16px;display:flex;flex-direction:column;gap:8px;max-height:40%;overflow:auto}
    .files__item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:#fff;font-size:12px;color:#111827;cursor:pointer}
    .files__item:hover{background:#f9fafb}
    .files__preview{flex:1;border-top:1px solid var(--border);padding:12px 16px;font-size:12px;color:#374151;overflow:auto}
    .workflow__footer{border-top:1px solid var(--border);padding:10px 16px;background:#fff}
    .footer-status{display:flex;align-items:center;gap:8px;font-size:12px;color:#4b5563;margin-bottom:8px}
    .footer-label{color:#6b7280}
    .footer-value{color:#111827;font-weight:600}
    .footer-sep{color:#d1d5db}
    
    /* 总体进度条（右侧）与阶段进度条（左侧黑盒） */
    .overall-progress{height:10px;width:100%;background:#eef2f7;border-radius:999px;overflow:hidden;margin:12px 0}
    .overall-progress__bar{height:100%;width:0%;background:linear-gradient(90deg, var(--accent), var(--progress));transition:width .2s ease}
    .phase{width:100%;max-width:840px;background:#fff;border:1px dashed #bfdbfe;border-radius:10px;padding:10px;margin:8px 0}
    .phase-title{font-size:13px;font-weight:700;color:#1f2937;margin:0 0 6px 0}
    .phase-progress{height:8px;width:100%;background:#eef2f7;border-radius:999px;overflow:hidden;margin:6px 0}
    .phase-progress__bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#3b82f6);transition:width .2s ease}
    
    .logs{flex:1;overflow:auto;padding:12px 14px;background:#fff}
    .log-line{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#374151;padding:4px 0;margin:2px 0;opacity:0;transform:translateY(6px);animation:fadeIn .2s ease forwards;border:none;background:transparent}
    
    /* 工具调用信息：使用简洁文本行（不再使用框式 execution-log） */
    .log-time{color:#64748b;font-weight:500;font-size:11px;min-width:50px}
    .log-tool{color:#1e40af;font-weight:600}
    .log-params{background:transparent;border:none;border-radius:0;padding:0;margin-top:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;color:#374151}
    .log-result{color:#059669;font-weight:600}
    .log-error{color:#dc2626;font-weight:600}

    /* 左侧聊天区的简洁工具调用行（无气泡、无边框） */
    .plain-log{width:100%;max-width:840px;margin:4px 0;color:#1f2937;font-size:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border-left:2px solid var(--accent-weak);padding-left:8px}
    

    .file-card{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;margin-top:8px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .file-icon{width:20px;height:24px;border:1px solid var(--border);border-radius:3px;background:linear-gradient(180deg,#f3f4f6,#e5e7eb);position:relative}
    .file-icon::after{content:'';position:absolute;top:0;right:0;width:8px;height:8px;background:#fff;border-left:1px solid var(--border);border-bottom:1px solid var(--border);transform:translate(1px,1px) rotate(45deg)}

    /* 评分组件样式 */
    .rating{margin-top:8px;user-select:none}
    .stars{display:flex;gap:4px;font-size:20px;cursor:pointer}
    .star{filter:grayscale(1) opacity(.6); transition:filter .15s ease,transform .06s}
    .star.active{filter:none}
    .star:active{transform:translateY(1px)}

    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

    /* 关键过渡：Phase 1 → Phase 2（视觉） */
    .to-workbench .launch{
      opacity:0;transform:translateY(-20px);
    }
    .to-workbench .launch .launch-left{display:none}
    .to-workbench .launch .launch-right{
      position:fixed;bottom:10px;left:50%;
      transform:translateX(-50%) translateY(0) scale(.98);
      width:min(980px,92vw);max-width:none;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);padding:12px;
      background:var(--card);border:1px solid var(--border);
    }
    .to-workbench .launch .logo{opacity:0;height:0;margin:0;transform:translateY(-6px)}
    .to-workbench .launch .hint{opacity:0;height:0}
    .to-workbench .launch .form .btn{border-radius:10px;padding:12px 16px}
    .to-workbench .launch .form .input{padding:12px 14px;font-size:14px}

    @media (max-width:960px){
      .columns{grid-template-columns:1fr}
      .panel__footer .form{max-width:100%}
      .msg{max-width:100%}
    }

    .hide{display:none}
    /* 架构与数据流可视化模态框 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.visible{display:flex}
    .modal__panel{width:min(920px,92vw);max-height:86vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.2)}
    .modal__head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal__title{margin:0;font-size:15px;font-weight:700}
    .modal__close{border:none;background:#f3f4f6;color:#374151;padding:6px 10px;border-radius:8px;cursor:pointer}
    .modal__body{padding:16px}
    .arch-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .arch-card{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
    .arch-card h4{margin:0 0 8px 0;font-size:13px}
    .arch-list{margin:0;padding-left:18px}
    .arch-list li{margin:6px 0;font-size:13px;color:#374151}
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <!-- Phase 1：全屏启动界面 -->
    <section class="launch" id="launch">
      <!-- 左侧：导航入口（15%） -->
      <aside class="launch-left" aria-label="导航入口">
        <div class="left-header">
          <h3 class="left-title">工作台</h3>
        </div>
        <div class="left-content">
          <div class="nav-buttons">
            <button class="nav-btn" id="nav-agents" data-page="agents">
              <span class="nav-icon">🤖</span>
              <span class="nav-text">智能体广场</span>
            </button>
            <button class="nav-btn" id="nav-plugins" data-page="plugins">
              <span class="nav-icon">🔌</span>
              <span class="nav-text">MCP插件广场</span>
            </button>
          </div>
        </div>
      </aside>
      <!-- 右侧：任务输入区（80%） -->
      <div class="launch-right">
        <div class="logo">
          <div class="logo-badge">WA</div>
          <h1 class="logo-title">Workflow Agent</h1>
        </div>
        <form id="mainForm" class="form">
          <input id="mainInput" class="input" type="text" placeholder="请输入您的任务..." />
          <button id="mainSend" class="btn" type="submit" aria-label="开始执行">开始</button>
        </form>
        <div class="hint">例如：请收集南海舆情的相关情况，生成一份简单的总结，并用一段音频内容播报这段总结内容</div>
        <div id="selectionBar" class="selected-bar" aria-live="polite"></div>
      </div>
    </section>

    <!-- 智能体广场页面 -->
    <section class="square-page hide" id="agents-page">
      <div class="square-header">
        <button class="back-btn" id="back-to-home">← 返回首页</button>
        <h2 class="square-title">智能体广场</h2>
      </div>
      <div class="square-content">
        <div class="square-toolbar">
          <input id="agentSearchSquare" class="input" placeholder="搜索智能体..." />
          <div id="agentChipsSquare" class="chips" aria-label="分类筛选"></div>
        </div>
        <div id="agentGridSquare" class="grid" aria-live="polite"></div>
      </div>
    </section>

    <!-- 插件广场页面 -->
    <section class="square-page hide" id="plugins-page">
      <div class="square-header">
        <button class="back-btn" id="back-to-home-plugins">← 返回首页</button>
        <h2 class="square-title">MCP插件广场</h2>
      </div>
      <div class="square-content">
        <div class="square-toolbar">
          <input id="pluginSearchSquare" class="input" placeholder="搜索插件..." />
          <div id="pluginChipsSquare" class="chips" aria-label="分类筛选"></div>
        </div>
        <div id="pluginGridSquare" class="grid" aria-live="polite"></div>
      </div>
    </section>

    <!-- Phase 2：工作台 -->
    <section class="workbench" id="workbench" aria-label="Workbench">
      <div class="columns single" id="columns">
        <!-- 左侧：对话历史（消息轨道在面板内部居中） -->
        <div class="panel">
          <div class="panel__head">
            <h2 class="title">对话历史</h2>
            <p class="subtitle">系统与用户消息</p>
          </div>
          <div id="chatContainer" class="chat__container"></div>
          <div class="panel__footer" id="panelFooter"></div>
        </div>

        <!-- 右侧：工作状态和日志（带标签与底部状态） -->
        <div class="workflow hide" id="workflowPanel">
          <div class="workflow__head">
            <h2 class="title" style="font-size:16px">工作台</h2>
            <div class="workflow__tabs" id="workflowTabs">
              <button class="workflow__tab workflow__tab--active" data-tab="follow">实时跟随</button>
              <button class="workflow__tab" data-tab="files">文件</button>
            </div>
          </div>
          <div class="workflow__body">
            <div class="tab-pane follow-pane active" id="tab-follow">
              <div class="logs" id="logs">
                <div class="log-line">提示：当任务开始后，这里将展示详细执行日志。</div>
              </div>
            </div>
            <div class="tab-pane files-pane" id="tab-files">
              <div class="files__header">产生的文件</div>
              <ul class="files__list" id="filesList"></ul>
              <div class="files__preview" id="filePreview">选择文件以查看详情</div>
            </div>
          </div>
          <div class="workflow__footer">
            <div class="footer-status">
              <span class="footer-label">状态</span>
              <span class="footer-value" id="currentStatus">等待中</span>
              <span class="footer-sep">|</span>
              <span class="footer-label">阶段</span>
              <span class="footer-value" id="currentPhase">-</span>
              <span class="footer-sep">|</span>
              <span class="footer-label">进度</span>
              <span class="footer-value" id="progressText">0%</span>
            </div>
            <div class="overall-progress"><div class="overall-progress__bar" id="overallBar"></div></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function(){
      const stage = document.getElementById('stage');
      const launch = document.getElementById('launch');
      const workbench = document.getElementById('workbench');
      const columns = document.getElementById('columns');
      const workflowPanel = document.getElementById('workflowPanel');
      
      // 页面路由相关
      const agentsPage = document.getElementById('agents-page');
      const pluginsPage = document.getElementById('plugins-page');
      const navAgents = document.getElementById('nav-agents');
      const navPlugins = document.getElementById('nav-plugins');
      const backToHome = document.getElementById('back-to-home');
      const backToHomePlugins = document.getElementById('back-to-home-plugins');

      const mainForm = document.getElementById('mainForm');
      const mainInput = document.getElementById('mainInput');
      const mainSend = document.getElementById('mainSend');
      // 广场页面元素
      const selectionBar = document.getElementById('selectionBar');
      const agentSearchSquare = document.getElementById('agentSearchSquare');
      const agentChipsSquare = document.getElementById('agentChipsSquare');
      const agentGridSquare = document.getElementById('agentGridSquare');
      const pluginSearchSquare = document.getElementById('pluginSearchSquare');
      const pluginChipsSquare = document.getElementById('pluginChipsSquare');
      const pluginGridSquare = document.getElementById('pluginGridSquare');
      // 输入框 hover 提示预设文案
      const presetText = '请收集南海舆情的相关情况，生成一份简单的总结，并用一段音频内容播报这段总结内容';


      const chatContainer = document.getElementById('chatContainer');
      const panelFooter = document.getElementById('panelFooter');

      const logs = document.getElementById('logs');
      const currentStatus = document.getElementById('currentStatus');
      const currentPhase = document.getElementById('currentPhase');
      const progressText = document.getElementById('progressText');
      const tabsRoot = document.getElementById('workflowTabs');
      const tabFollow = document.getElementById('tab-follow');
      const tabFiles = document.getElementById('tab-files');
      const filesList = document.getElementById('filesList');
      const filePreview = document.getElementById('filePreview');
      // 无障碍：动态内容区域播报
      chatContainer.setAttribute('aria-live','polite');
      logs.setAttribute('aria-live','polite');

      let isBusy = false;
      let transitioned = false;
      let currentPage = 'home';

      // 页面路由功能
      function showPage(pageName) {
        // 隐藏所有页面
        launch.classList.add('hide');
        agentsPage.classList.add('hide');
        pluginsPage.classList.add('hide');
        
        // 显示目标页面
        if (pageName === 'home') {
          launch.classList.remove('hide');
        } else if (pageName === 'agents') {
          agentsPage.classList.remove('hide');
          agentsPage.classList.add('visible');
        } else if (pageName === 'plugins') {
          pluginsPage.classList.remove('hide');
          pluginsPage.classList.add('visible');
        }
        
        currentPage = pageName;
      }

      // 导航按钮事件
      navAgents.addEventListener('click', () => showPage('agents'));
      navPlugins.addEventListener('click', () => showPage('plugins'));
      backToHome.addEventListener('click', () => showPage('home'));
      backToHomePlugins.addEventListener('click', () => showPage('home'));

      function scrollChat(){ chatContainer.scrollTop = chatContainer.scrollHeight; }
      function scrollLogs(){ logs.scrollTop = logs.scrollHeight; }
      function setBusy(b){ isBusy = b; mainInput.disabled = b; mainSend.disabled = b; }
      
      function updateStatus(status, phase = null) {
        currentStatus.textContent = status;
        if (phase) currentPhase.textContent = phase;
      }
      
      function updateProgress(percent) {
        progressText.textContent = Math.round(percent) + '%';
      }

      // 右侧面板标签切换
      function initTabs(){
        if(!tabsRoot) return;
        tabsRoot.addEventListener('click', (e)=>{
          const btn = e.target.closest('.workflow__tab');
          if(!btn) return;
          const name = btn.getAttribute('data-tab');
          tabsRoot.querySelectorAll('.workflow__tab').forEach(b=>b.classList.remove('workflow__tab--active'));
          btn.classList.add('workflow__tab--active');
          tabFollow.classList.toggle('active', name==='follow');
          tabFiles.classList.toggle('active', name==='files');
        });
      }
      initTabs();

      // 文件列表动态更新
      const producedFiles = [];
      function addFileRecord(name, content){
        const record = { name, content, time: new Date().toLocaleTimeString('zh-CN', {hour12:false}) };
        producedFiles.push(record);
        renderFiles();
      }
      function renderFiles(){
        if(!filesList) return;
        filesList.innerHTML = '';
        producedFiles.forEach((f, idx)=>{
          const li = document.createElement('li');
          li.className = 'files__item';
          li.innerHTML = `<span>${f.name}</span><span style="color:#6b7280">${f.time}</span>`;
          li.addEventListener('click', ()=>{
            if(filePreview) filePreview.textContent = f.content || '暂无预览内容';
          });
          filesList.appendChild(li);
        });
      }

      function addMessage({ role = 'system', html = '' }){
        const msg = document.createElement('div');
        msg.className = 'msg ' + (role === 'user' ? 'msg--user' : '');
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (role === 'user' ? 'bubble--user' : 'bubble--system');
        if(role === 'user'){
          bubble.textContent = html; // XSS 防护：用户内容用文本
        }else{
          bubble.innerHTML = html;
        }
        msg.appendChild(bubble);
        chatContainer.appendChild(msg);
        scrollChat();
        return { msg, bubble };
      }
      async function typeText(el, text, speed = 30){
        return new Promise(resolve=>{
          let i = 0;
          const timer = setInterval(()=>{
            if(i < text.length){
              el.textContent += text[i++];
              scrollChat();
            }else{ clearInterval(timer); resolve(); }
          }, speed);
        });
      }
      async function addTypedMessage({ role = 'system', prefixHtml = '', text = '', speed = 30 }){
        const { bubble } = addMessage({ role, html: `${prefixHtml}<span class="typewriter-text"></span>` });
        const el = bubble.querySelector('.typewriter-text');
        await typeText(el, text, speed);
        return bubble;
      }
      function addFlowLine(text, level = 0, strong = false){
        const line = document.createElement('div');
        line.className = 'flow-line ' + (level>0?`indent-${level}`:'root');
        line.innerHTML = strong ? `<span>• ${text}</span>` : text;
        chatContainer.appendChild(line);
        scrollChat();
        return line;
      }
      function updateBubble(bubble, html){ bubble.innerHTML = html; scrollChat(); }

      function appendLog(text, type = 'info'){
        const line = document.createElement('div');
        line.className = 'log-line';
        
        const timestamp = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        const typeIcon = {
          'info': '•',
          'success': '✓',
          'warning': '!',
          'error': '✗',
          'debug': '?'
        }[type] || '•';
        
        line.innerHTML = `<span style="color:#6b7280;margin-right:8px">[${timestamp}]</span><span style="margin-right:8px">${typeIcon}</span>${text}`;
        logs.appendChild(line);
        scrollLogs();
      }
      
      function appendDetailedLog(agent, action, details, status = 'info'){
        const timestamp = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        const line = document.createElement('div');
        line.className = 'log-line';
        
        const statusIcon = {
          'start': '▶',
          'running': '●',
          'success': '✓',
          'error': '✗',
          'debug': '?'
        }[status] || '•';
        
        line.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span style="color:#6b7280">[${timestamp}] ${statusIcon}</span>
            <span style="color:#1e40af;font-weight:600">${agent}</span>
          </div>
          <div style="color:#374151;margin-bottom:2px">${action}</div>
          <div style="color:#6b7280;font-size:11px">${details}</div>
        `;
        logs.appendChild(line);
        scrollLogs();
      }
      
      // 工具调用日志
      function addExecutionLog(stepIndex, toolName, action, type = 'start', params = null, result = null){
        const time = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        const parts = [];
        if(type === 'start'){
          parts.push(`开始执行步骤${stepIndex + 1}: [${toolName}] - ${action}`);
        }else if(type === 'running'){
          parts.push(`执行中 步骤${stepIndex + 1}: [${toolName}] - ${action}`);
        }else if(type === 'completed'){
          parts.push(`步骤${stepIndex + 1}完成: [${toolName}] 返回 ${result ?? '成功'}`);
        }else if(type === 'failed'){
          parts.push(`步骤${stepIndex + 1}失败: [${toolName}] - ${action}`);
        }
        if(params){
          parts.push(`<span class="log-params">调用[${toolName}] 参数: ${JSON.stringify(params)}</span>`);
        }
        const line = document.createElement('div');
        line.className = 'plain-log';
        line.setAttribute('data-type', type);
        line.innerHTML = `<span class="log-time">[${time}]</span> ${parts.join('<br/>')}`;
        chatContainer.appendChild(line);
        scrollChat();
        
      }
      
      // 抽象进度条已移除，统一用具体工具调用日志替代


      async function showPlanningAndBindStart(){
        // 1) 需求分析：简约气泡 + 左上角“思考中...”标签 + 打字机
        const analysisText = "分析用户需求：需要收集南海地区最新舆情动态并生成总结报告和音频播报。首先需要获取南海相关的最新新闻、热点事件和舆情数据，然后对信息进行筛选分类和关键点提取。考虑到音频播报需求，需要将总结内容结构化，分为舆情概述、热点分析、趋势预测等部分。需要确保信息来源权威准确，最后生成简洁明了的总结报告并转换为语音格式。";

        const thinkHtml = `
          <div class="thought thinking-bubble">
            <div class="tag">思考中...</div>
            <div class="thought-body" data-collapsed="true" style="max-height:120px;overflow:hidden">
              <span class="typewriter-text"></span>
            </div>
            <div class="thought-footer"><button class="thought-toggle" type="button">展开</button></div>
          </div>`;
        const { bubble } = addMessage({ role:'system', html: thinkHtml });
        const toggle = bubble.querySelector('.thought-toggle');
        const body = bubble.querySelector('.thought-body');
        const typewriterEl = bubble.querySelector('.typewriter-text');
        
        // 打字机效果（等待其完成后再进入执行阶段）
        const typingDone = typeText(typewriterEl, analysisText, 30);
        await typingDone;
        toggle.style.display = 'block';
        
        toggle.addEventListener('click', ()=>{
          const collapsed = body.getAttribute('data-collapsed') === 'true';
          if(collapsed){ body.style.maxHeight = 'none'; toggle.textContent = '收起'; }
          else { body.style.maxHeight = '120px'; toggle.textContent = '展开'; }
          body.setAttribute('data-collapsed', (!collapsed).toString());
        });

        // 2) 自动开始执行（严格顺序：在需求分析完全显示后）
        // 保持 busy 状态以阻止用户输入，并继续执行后续步骤
        setBusy(true);
          updateStatus('需求分析中', '分析阶段'); updateProgress(5);
          appendDetailedLog('System', '需求分析', '完成需求分析，准备执行', 'success');

          // 定义精简工具调用流程（无复杂参数展示）
          const calls = [
            { tool:'Serper API', action:'检索南海相关新闻与舆情数据' },
            { tool:'Text Analysis', action:'对信息进行聚类与关键点提取' },
            { tool:'Report Generator', action:'生成结构化总结报告' },
            { tool:'TTS Engine', action:'将总结内容转换为语音播报', decision:true }
          ];

          const overallBar = document.getElementById('overallBar');

          for(let i=0;i<calls.length;i++){
            const c = calls[i];

            // 在第一个工具调用开始时，展开右侧面板与双栏布局
            if(i===0){
              // 展开工作台布局
              columns.classList.remove('single');
              // 显示右侧面板并添加动画
              workflowPanel.classList.remove('hide');
              setTimeout(() => {
                workflowPanel.classList.add('visible');
              }, 100);
            }

            // 步骤开始（根级别，黑点强调，系统气泡逐字）
            const stepTitles = [
              '• 现在开始收集南海舆情的相关资料...',
              '• 开始分析舆情数据并提取关键点...',
              '• 开始生成结构化总结报告...',
              '• 开始生成音频播报内容...'
            ];
            await addTypedMessage({ role: 'system', prefixHtml: '', text: stepTitles[i], speed: 24 });
            updateStatus('执行中', c.action);

            // 步骤内操作（系统气泡逐字）
            await addTypedMessage({ role: 'system', prefixHtml: '', text: `调用${c.tool}，${c.action}`, speed: 26 });
            appendLog(`调用 ${c.tool}：${c.action}`, 'info');

            // 步骤内思考（系统气泡逐字）
            const stepThoughts = [
              '基于搜索结果，发现需要调整关键词覆盖更多维度',
              '基于聚类分析结果，识别出主要观点和趋势',
              '基于分析结果，构建结构化的报告框架',
              '基于报告内容，准备语音播报参数'
            ];
            await addTypedMessage({ role: 'system', prefixHtml: '', text: stepThoughts[i], speed: 26 });

            // 如需用户决策，则在调用前插入对话内选择
            if(c.decision){
              const choiceHtml = `
                <div class="inline-choice">
                  <div class="inline-choice-title">请选择播报风格</div>
                  <div class="inline-choice-options">
                    <button class="inline-choice-btn" data-voice="kanghui">康辉</button>
                    <button class="inline-choice-btn" data-voice="dongxuan">董璇</button>
                    <button class="inline-choice-btn" data-voice="trump">特朗普</button>
                  </div>
                  <div class="inline-choice-status small">等待您的选择...</div>
                </div>
              `;
              const { bubble: choiceBubble } = addMessage({ role:'system', html: choiceHtml });
              await new Promise(resolve=>{
                choiceBubble.querySelectorAll('.inline-choice-btn').forEach(btn=>{
                  btn.addEventListener('click', ()=>{
                    choiceBubble.querySelectorAll('.inline-choice-btn').forEach(b=>b.classList.remove('selected'));
                    btn.classList.add('selected');
                    const st = choiceBubble.querySelector('.inline-choice-status');
                    st.textContent = `已选择：${btn.textContent}`;
                    st.style.color = '#059669';
                    appendLog(`用户选择语音风格：${btn.textContent}`, 'success');
                  resolve(); 
                  });
                });
              });
            }

            // 模拟工具执行进度（简化）
            await new Promise(resolve=>{
              const total = 1200 + Math.random()*800; const start = Date.now();
              const t = setInterval(()=>{
                const p = Math.min(100, Math.round((Date.now()-start)/total*100));
                const overall = Math.round(((i + p/100)/calls.length)*100);
                overallBar.style.width = overall + '%'; updateProgress(overall);
                if(p>=100){ clearInterval(t); resolve(); }
              }, 100);
            });

            appendLog(`完成：${c.tool} - ${c.action}`, 'success');
            // 步骤间思考（简约思考气泡 + 打字机）
            const betweenThoughts = [
              '基于舆情数据收集结果，下一步需要进行信息聚类分析',
              '基于聚类分析结果，下一步需要生成结构化总结报告',
              '总结报告已生成，下一步将文本内容转换为语音播报'
            ];
            if(i < betweenThoughts.length){
              const bt = `\n          <div class=\"thought thinking-bubble\">\n            <div class=\"tag\">思考中...</div>\n            <div class=\"thought-body\"><span class=\"typewriter-text\"></span></div>\n          </div>`;
              const { bubble: btBubble } = addMessage({ role:'system', html: bt });
              const el = btBubble.querySelector('.typewriter-text');
              await typeText(el, betweenThoughts[i], 26);
            }
          }

          // 结果输出：先简洁总结，再简洁结果卡片
          updateStatus('任务完成', '全部完成'); updateProgress(100);
          addMessage({ role:'system', html: '任务完成：已生成舆情总结与音频播报。' });
          addMessage({ role:'system', html: `
            <div class="result-card minimal">
              <div class="result-header">
                <span class="result-title">结果</span>
                </div>
              <div class="result-content">
                <div class="result-item">舆情总结：南海热点集中在资源开发争议与地区博弈。</div>
                <div class="result-item">音频播报：<a href="#" style="color:#2563eb;text-decoration:none">点击播放</a>（约2分30秒）</div>
                </div>
              <div class="result-meta">${new Date().toLocaleString('zh-CN')}</div>
              </div>
          `});

          setBusy(false);
        
      }

      // 步骤间思考：基于上一步结果决定下一步
      function continueThinking(prevCall, index, total){
        const texts = [
          '基于舆情数据分析，下一步需要生成结构化报告',
          '基于聚类分析结果，下一步需要生成结构化总结报告',
          '总结报告已生成，下一步将文本内容转换为语音播报',
          '音频生成完成，准备输出最终结果'
        ];
        const content = texts[Math.min(index, texts.length-1)];
        // 步骤间过渡思考：与步骤开始同级（不缩进）
        addFlowLine(content, 0, false);
      }

      function dockFormIntoPanel(){
        // 迁移选择徽章到工作台输入区上方
        const container = document.createElement('div');
        container.className = 'selected-bar';
        container.id = 'selectionBarDocked';
        panelFooter.innerHTML = '';
        panelFooter.appendChild(container);
        panelFooter.appendChild(mainForm);
        launch.classList.add('hide');
        // 同步徽章
        function syncDocked(){
          container.innerHTML = selectionBar.innerHTML;
          container.querySelectorAll('.x').forEach(x=>{
            x.addEventListener('click', ()=>{
              const type = x.getAttribute('data-type');
              const id = x.getAttribute('data-id');
              if(type==='agent') selected.agents.delete(id); else selected.plugins.delete(id);
              // 重渲染两端
              const evt = new Event('sync');
              selectionBar.dispatchEvent(evt);
            });
          });
        }
        selectionBar.addEventListener('sync', ()=>{
          renderBadges();
          renderAgentGrid();
          renderPluginGrid();
          syncDocked();
        });
        // 首次同步
        syncDocked();
      }

      function startTransition(){
        if(transitioned) {
          // 如果已经跳转过，确保工作台可见
          workbench.classList.add('visible');
          return;
        }
        transitioned = true;
        document.body.classList.add('to-workbench');
        setTimeout(()=>{
          workbench.classList.add('visible');
          dockFormIntoPanel();
          mainInput && mainInput.focus();
        }, 150);
      }

      function handleUserInput(text){
        const trimmed = text.trim();
        if(!trimmed) return;

        // 修正：改为识别南海和视频相关关键词
        const lower = trimmed.toLowerCase();
        const hasSouthChinaSea = lower.includes('南海') || lower.includes('south china sea') || lower.includes('南中国海');
        const hasVideo = lower.includes('视频') || lower.includes('video') || lower.includes('脚本') || lower.includes('总结');

        if(!(hasSouthChinaSea && hasVideo)){
          addMessage({ role:'system', html:'您好！现在提供三种入口：在"任务"页直接输入，或先到"智能体广场 / MCP 插件广场"浏览并选择后再输入。演示任务建议包含"南海"和"总结"。' });
          return;
        }

        startTransition();

        // 新顺序：先显示用户消息（右侧气泡），再显示系统确认（左侧气泡）
        addMessage({ role:'user', html: trimmed });
        addMessage({ role:'system', html:'已经收到你的任务，即将开始分析' });
        
        appendLog('收到新任务：开始需求分析', 'info');
        appendDetailedLog('System', '任务接收', '用户输入已接收，开始需求分析', 'start');

        // 2. 延迟后开始显示需求分析（不在此处解除忙碌；交给分析完成后处理）
        setBusy(true);
        setTimeout(()=>{ showPlanningAndBindStart(); }, 1500);
      }

      mainForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(isBusy) return;
        const v = mainInput.value;
        handleUserInput(v);
        // 在接受任务后再清空输入框
        const lower = v.toLowerCase();
        const ok = (lower.includes('南海') || lower.includes('south china sea') || lower.includes('南中国海')) && (lower.includes('视频') || lower.includes('video') || lower.includes('脚本') || lower.includes('总结'));
        if(ok){ mainInput.value = ''; }
      });

      // ====== 启动页左侧标签切换 ======
      function switchTab(name){
        tabs.forEach(t=>{
          const active = t.dataset.tab === name;
          t.classList.toggle('tab--active', active);
          t.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        Object.entries(panels).forEach(([key, el])=>{
          el.classList.toggle('active', key === name);
        });
      }
      tabs.forEach(t=>{
        t.addEventListener('click', ()=> switchTab(t.dataset.tab));
      });

      // ====== 数据：智能体与插件 ======
      const agentCatalog = [
        { id:'agent-da', name:'数据分析助手', desc:'表格/可视化/探索性分析', category:'数据分析' },
        { id:'agent-cc', name:'内容创作助手', desc:'写作/改写/总结', category:'内容创作' },
        { id:'agent-code', name:'代码助手', desc:'代码补全/调试/重构', category:'开发工具' },
        { id:'agent-research', name:'检索研究员', desc:'资料检索/引用管理', category:'研究' },
        { id:'agent-audio', name:'音频制作', desc:'TTS/配音/剪辑建议', category:'多媒体' },
        { id:'agent-video', name:'视频脚本助手', desc:'脚本/分镜/旁白', category:'多媒体' }
      ];
      const pluginCatalog = [
        { id:'plg-serper', name:'Serper 搜索', desc:'谷歌搜索 API', category:'搜索引擎' },
        { id:'plg-openapi', name:'OpenAPI 连接器', desc:'对接任意 OpenAPI', category:'API 连接器' },
        { id:'plg-csv', name:'CSV 处理器', desc:'解析/筛选/统计', category:'数据处理' },
        { id:'plg-db', name:'数据库连接器', desc:'查询与可视化', category:'数据处理' },
        { id:'plg-image', name:'图像处理', desc:'压缩/滤镜/识别', category:'多媒体' },
        { id:'plg-tts', name:'TTS 引擎', desc:'文本转语音', category:'多媒体' }
      ];

      const agentCategories = ['全部','数据分析','内容创作','开发工具','研究','多媒体'];
      const pluginCategories = ['全部','搜索引擎','API 连接器','数据处理','多媒体'];

      const selected = { agents: new Set(), plugins: new Set() };

      function renderBadges(){
        selectionBar.innerHTML = '';
        [...selected.agents].forEach(id=>{
          const item = agentCatalog.find(x=>x.id===id);
          if(!item) return;
          const b = document.createElement('span');
          b.className = 'badge';
          b.innerHTML = `${item.name}<span class="x" data-type="agent" data-id="${id}">✕</span>`;
          selectionBar.appendChild(b);
        });
        [...selected.plugins].forEach(id=>{
          const item = pluginCatalog.find(x=>x.id===id);
          if(!item) return;
          const b = document.createElement('span');
          b.className = 'badge';
          b.innerHTML = `${item.name}<span class="x" data-type="plugin" data-id="${id}">✕</span>`;
          selectionBar.appendChild(b);
        });
        selectionBar.querySelectorAll('.x').forEach(x=>{
          x.addEventListener('click', ()=>{
            const type = x.getAttribute('data-type');
            const id = x.getAttribute('data-id');
            if(type==='agent') selected.agents.delete(id); else selected.plugins.delete(id);
            renderBadges();
            renderAgentGrid();
            renderPluginGrid();
          });
        });
        // 通知工作台徽章同步
        const evt = new Event('sync');
        selectionBar.dispatchEvent(evt);
      }

      function buildChips(container, categories, onPick){
        container.innerHTML = '';
        categories.forEach((c, idx)=>{
          const el = document.createElement('button');
          el.type = 'button';
          el.className = 'chip' + (idx===0 ? ' active' : '');
          el.textContent = c;
          el.addEventListener('click', ()=>{
            container.querySelectorAll('.chip').forEach(n=>n.classList.remove('active'));
            el.classList.add('active');
            onPick(c);
          });
          container.appendChild(el);
        });
      }

      let agentFilter = { q:'', cat:'全部' };
      let pluginFilter = { q:'', cat:'全部' };

      function renderAgentGrid(targetGrid = agentGridSquare){
        const q = agentFilter.q.trim().toLowerCase();
        const cat = agentFilter.cat;
        const list = agentCatalog.filter(a=>
          (cat==='全部'||a.category===cat) &&
          (!q || a.name.toLowerCase().includes(q) || a.desc.toLowerCase().includes(q))
        );
        targetGrid.innerHTML = '';
        list.forEach(a=>{
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h4>${a.name}</h4>
            <p>${a.desc}</p>
            <div class="meta"><span>${a.category}</span>
            <button class="select-btn ${selected.agents.has(a.id)?'selected':''}" data-id="${a.id}">${selected.agents.has(a.id)?'已选择':'选择'}</button></div>`;
          targetGrid.appendChild(card);
          const btn = card.querySelector('.select-btn');
          btn.addEventListener('click', ()=>{
            if(selected.agents.has(a.id)) selected.agents.delete(a.id); else selected.agents.add(a.id);
            renderAgentGrid(targetGrid);
            renderBadges();
          });
        });
      }

      function renderPluginGrid(targetGrid = pluginGridSquare){
        const q = pluginFilter.q.trim().toLowerCase();
        const cat = pluginFilter.cat;
        const list = pluginCatalog.filter(p=>
          (cat==='全部'||p.category===cat) &&
          (!q || p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q))
        );
        targetGrid.innerHTML = '';
        list.forEach(p=>{
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h4>${p.name}</h4>
            <p>${p.desc}</p>
            <div class="meta"><span>${p.category}</span>
            <button class="select-btn ${selected.plugins.has(p.id)?'selected':''}" data-id="${p.id}">${selected.plugins.has(p.id)?'已启用':'启用'}</button></div>`;
          targetGrid.appendChild(card);
          const btn = card.querySelector('.select-btn');
          btn.addEventListener('click', ()=>{
            if(selected.plugins.has(p.id)) selected.plugins.delete(p.id); else selected.plugins.add(p.id);
            renderPluginGrid(targetGrid);
            renderBadges();
          });
        });
      }

      // 初始化首页功能（已移除，现在使用广场页面）
      
      // 初始化广场页面功能
      buildChips(agentChipsSquare, agentCategories, (c)=>{ agentFilter.cat=c; renderAgentGrid(agentGridSquare); });
      buildChips(pluginChipsSquare, pluginCategories, (c)=>{ pluginFilter.cat=c; renderPluginGrid(pluginGridSquare); });
      agentSearchSquare.addEventListener('input', ()=>{ agentFilter.q = agentSearchSquare.value; renderAgentGrid(agentGridSquare); });
      pluginSearchSquare.addEventListener('input', ()=>{ pluginFilter.q = pluginSearchSquare.value; renderPluginGrid(pluginGridSquare); });
      renderAgentGrid(agentGridSquare);
      renderPluginGrid(pluginGridSquare);
      renderBadges();
    })();
  </script>
  
</body>
</html>
